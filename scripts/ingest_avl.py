import datetime
import glob
import polling as polling
import avl_spec
import requests
import json
import pandas as pd
import os
import logging

text_files = glob.glob("/Volumes/felipetoshiba/SPTrans/Janeiro/inputs/*.txt")
headers = {'content-type': 'application/json'}
processed = ["Movto_201701010200_201701010300.txt",
             "Movto_201701010200_201701010300.txt",
             "Movto_201701010500_201701010600.txt",
             "Movto_201701010600_201701010700.txt",
             "Movto_201701010800_201701010900.txt",
             "Movto_201701010900_201701011000.txt",
             "Movto_201701011000_201701011100.txt",
             "Movto_201701011100_201701011200.txt",
             "Movto_201701011200_201701011300.txt",
             "Movto_201701011300_201701011400.txt",
             "Movto_201701011400_201701011500.txt",
             "Movto_201701011500_201701011600.txt",
             "Movto_201701011600_201701011700.txt",
             "Movto_201701011700_201701011800.txt",
             "Movto_201701011800_201701011900.txt",
             "Movto_201701011900_201701012000.txt",
             "Movto_201701012000_201701012100.txt",
             "Movto_201701012100_201701012200.txt",
             "Movto_201701012200_201701012300.txt",
             "Movto_201701012300_201701020000.txt",
             "Movto_201701020000_201701020100.txt",
             "Movto_201701020100_201701020200.txt",
             "Movto_201701020200_201701020300.txt",
             "Movto_201701020300_201701020400.txt",
             "Movto_201701020400_201701020500.txt",
             "Movto_201701020500_201701020600.txt",
             "Movto_201701020600_201701020700.txt",
             "Movto_201701020700_201701020800.txt",
             "Movto_201701020800_201701020900.txt",
             "Movto_201701020900_201701021000.txt",
             "Movto_201701021000_201701021100.txt",
             "Movto_201701021100_201701021200.txt",
             "Movto_201701021200_201701021300.txt",
             "Movto_201701021300_201701021400.txt",
             "Movto_201701021400_201701021500.txt",
             "Movto_201701021500_201701021600.txt",
             "Movto_201701021600_201701021700.txt",
             "Movto_201701021700_201701021800.txt",
             "Movto_201701021800_201701021900.txt",
             "Movto_201701021900_201701022000.txt",
             "Movto_201701022000_201701022100.txt",
             "Movto_201701022100_201701022200.txt",
             "Movto_201701022200_201701022300.txt",
             "Movto_201701022300_201701030000.txt",
             "Movto_201701030000_201701030100.txt",
             "Movto_201701030100_201701030200.txt",
             "Movto_201701030200_201701030300.txt",
             "Movto_201701030300_201701030400.txt",
             "Movto_201701030400_201701030500.txt",
             "Movto_201701030600_201701030700.txt",
             "Movto_201701030700_201701030800.txt",
             "Movto_201701030800_201701030900.txt",
             "Movto_201701030900_201701031000.txt",
             "Movto_201701031000_201701031100.txt",
             "Movto_201701031100_201701031200.txt",
             "Movto_201701031200_201701031300.txt",
             "Movto_201701031300_201701031400.txt",
             "Movto_201701031400_201701031500.txt",
             "Movto_201701031600_201701031700.txt",
             "Movto_201701031700_201701031800.txt",
             "Movto_201701031800_201701031900.txt",
             "Movto_201701031900_201701032000.txt",
             "Movto_201701032000_201701032100.txt",
             "Movto_201701032100_201701032200.txt",
             "Movto_201701032200_201701032300.txt",
             "Movto_201701032300_201701040000.txt",
             "Movto_201701040000_201701040100.txt",
             "Movto_201701040100_201701040200.txt",
             "Movto_201701040200_201701040300.txt",
             "Movto_201701040300_201701040400.txt",
             "Movto_201701040400_201701040500.txt",
             "Movto_201701040500_201701040600.txt",
             "Movto_201701040600_201701040700.txt",
             "Movto_201701040700_201701040800.txt",
             "Movto_201701040800_201701040900.txt",
             "Movto_201701040900_201701041000.txt",
             "Movto_201701041000_201701041100.txt",
             "Movto_201701041100_201701041200.txt",
             "Movto_201701041200_201701041300.txt",
             "Movto_201701041300_201701041400.txt",
             "Movto_201701041400_201701041500.txt",
             "Movto_201701041500_201701041600.txt",
             "Movto_201701041600_201701041700.txt",
             "Movto_201701041700_201701041800.txt",
             "Movto_201701041800_201701041900.txt",
             "Movto_201701041900_201701042000.txt",
             "Movto_201701042000_201701042100.txt",
             "Movto_201701042100_201701042200.txt",
             "Movto_201701042200_201701042300.txt",
             "Movto_201701042300_201701050000.txt",
             "Movto_201701050000_201701050100.txt",
             "Movto_201701050100_201701050200.txt",
             "Movto_201701050200_201701050300.txt",
             "Movto_201701050300_201701050400.txt",
             "Movto_201701050400_201701050500.txt",
             "Movto_201701050500_201701050600.txt",
             "Movto_201701050600_201701050700.txt",
             "Movto_201701050700_201701050800.txt",
             "Movto_201701050800_201701050900.txt",
             "Movto_201701050900_201701051000.txt",
             "Movto_201701051100_201701051200.txt",
             "Movto_201701051200_201701051300.txt",
             "Movto_201701051300_201701051400.txt",
             "Movto_201701051400_201701051500.txt",
             "Movto_201701051500_201701051600.txt",
             "Movto_201701051600_201701051700.txt",
             "Movto_201701051700_201701051800.txt",
             "Movto_201701051800_201701051900.txt",
             "Movto_201701051900_201701052000.txt",
             "Movto_201701052000_201701052100.txt",
             "Movto_201701052100_201701052200.txt",
             "Movto_201701052200_201701052300.txt",
             "Movto_201701052300_201701060000.txt",
             "Movto_201701060000_201701060100.txt",
             "Movto_201701060100_201701060200.txt",
             "Movto_201701060200_201701060300.txt",
             "Movto_201701060300_201701060400.txt",
             "Movto_201701060400_201701060500.txt",
             "Movto_201701060500_201701060600.txt",
             "Movto_201701060600_201701060700.txt",
             "Movto_201701060700_201701060800.txt",
             "Movto_201701060800_201701060900.txt",
             "Movto_201701060900_201701061000.txt",
             "Movto_201701061000_201701061100.txt",
             "Movto_201701061100_201701061200.txt",
             "Movto_201701061300_201701061400.txt",
             "Movto_201701061400_201701061500.txt",
             "Movto_201701061500_201701061600.txt",
             "Movto_201701061600_201701061700.txt",
             "Movto_201701061700_201701061800.txt",
             "Movto_201701061800_201701061900.txt",
             "Movto_201701061900_201701062000.txt",
             "Movto_201701062000_201701062100.txt",
             "Movto_201701062100_201701062200.txt",
             "Movto_201701062200_201701062300.txt",
             "Movto_201701062300_201701070000.txt",
             "Movto_201701070000_201701070100.txt",
             "Movto_201701070100_201701070200.txt",
             "Movto_201701070200_201701070300.txt",
             "Movto_201701070300_201701070400.txt",
             "Movto_201701070400_201701070500.txt",
             "Movto_201701070500_201701070600.txt",
             "Movto_201701070600_201701070700.txt",
             "Movto_201701070700_201701070800.txt",
             "Movto_201701070800_201701070900.txt",
             "Movto_201701070900_201701071000.txt",
             "Movto_201701071000_201701071100.txt",
             "Movto_201701071100_201701071200.txt",
             "Movto_201701071200_201701071300.txt",
             "Movto_201701071300_201701071400.txt",
             "Movto_201701071400_201701071500.txt",
             "Movto_201701071500_201701071600.txt",
             "Movto_201701071600_201701071700.txt",
             "Movto_201701071700_201701071800.txt",
             "Movto_201701071800_201701071900.txt",
             "Movto_201701071900_201701072000.txt",
             "Movto_201701072000_201701072100.txt",
             "Movto_201701072100_201701072200.txt",
             "Movto_201701072200_201701072300.txt",
             "Movto_201701072300_201701080000.txt",
             "Movto_201701080100_201701080200.txt",
             "Movto_201701080200_201701080300.txt",
             "Movto_201701080300_201701080400.txt",
             "Movto_201701080400_201701080500.txt",
             "Movto_201701080500_201701080600.txt",
             "Movto_201701080600_201701080700.txt",
             "Movto_201701080700_201701080800.txt",
             "Movto_201701080800_201701080900.txt",
             "Movto_201701080900_201701081000.txt",
             "Movto_201701081000_201701081100.txt",
             "Movto_201701081100_201701081200.txt",
             "Movto_201701081200_201701081300.txt",
             "Movto_201701081300_201701081400.txt",
             "Movto_201701081400_201701081500.txt",
             "Movto_201701081500_201701081600.txt",
             "Movto_201701081600_201701081700.txt",
             "Movto_201701081700_201701081800.txt",
             "Movto_201701081800_201701081900.txt",
             "Movto_201701081900_201701082000.txt",
             "Movto_201701082000_201701082100.txt",
             "Movto_201701082100_201701082200.txt",
             "Movto_201701082300_201701090000.txt",
             "Movto_201701090000_201701090100.txt",
             "Movto_201701090100_201701090200.txt",
             "Movto_201701090200_201701090300.txt",
             "Movto_201701090300_201701090400.txt",
             "Movto_201701090500_201701090600.txt",
             "Movto_201701090600_201701090700.txt",
             "Movto_201701090700_201701090800.txt",
             "Movto_201701090800_201701090900.txt",
             "Movto_201701090900_201701091000.txt",
             "Movto_201701091000_201701091100.txt",
             "Movto_201701091100_201701091200.txt",
             "Movto_201701091200_201701091300.txt",
             "Movto_201701091300_201701091400.txt",
             "Movto_201701091400_201701091500.txt",
             "Movto_201701091500_201701091600.txt",
             "Movto_201701091600_201701091700.txt",
             "Movto_201701091700_201701091800.txt",
             "Movto_201701091800_201701091900.txt",
             "Movto_201701091900_201701092000.txt",
             "Movto_201701092000_201701092100.txt",
             "Movto_201701092100_201701092200.txt",
             "Movto_201701092300_201701100000.txt",
             "Movto_201701100000_201701100100.txt",
             "Movto_201701100100_201701100200.txt",
             "Movto_201701100200_201701100300.txt",
             "Movto_201701100300_201701100400.txt",
             "Movto_201701100400_201701100500.txt",
             "Movto_201701100500_201701100600.txt",
             "Movto_201701100600_201701100700.txt",
             "Movto_201701100700_201701100800.txt",
             "Movto_201701100800_201701100900.txt",
             "Movto_201701100900_201701101000.txt",
             "Movto_201701101000_201701101100.txt",
             "Movto_201701101100_201701101200.txt",
             "Movto_201701101200_201701101300.txt",
             "Movto_201701101300_201701101400.txt",
             "Movto_201701101400_201701101500.txt",
             "Movto_201701101500_201701101600.txt",
             "Movto_201701101600_201701101700.txt",
             "Movto_201701101700_201701101800.txt",
             "Movto_201701101800_201701101900.txt",
             "Movto_201701101900_201701102000.txt",
             "Movto_201701102000_201701102100.txt",
             "Movto_201701102100_201701102200.txt",
             "Movto_201701102200_201701102300.txt",
             "Movto_201701102300_201701110000.txt",
             "Movto_201701110000_201701110100.txt",
             "Movto_201701110100_201701110200.txt",
             "Movto_201701110300_201701110400.txt",
             "Movto_201701110400_201701110500.txt",
             "Movto_201701110500_201701110600.txt",
             "Movto_201701110600_201701110700.txt",
             "Movto_201701110700_201701110800.txt",
             "Movto_201701110800_201701110900.txt"]

logging.basicConfig(filename='ingest_avl.log', level=logging.DEBUG)

for text_file in text_files:
    output_file_name = ""
    try:
        file_name = text_file.split("/")[-1]
        output_file_name = file_name.replace(".txt", ".csv")
        if file_name not in processed:
            file = pd.read_csv(text_file, encoding='utf-8', sep=';')
            file.to_csv(output_file_name, sep=",", index=False)

            spec = avl_spec.ingest
            spec["spec"]["ioConfig"]["inputSpec"]["paths"] = os.path.join(os.path.dirname(os.path.abspath(__file__)),
                                                                          output_file_name)
            from_date = datetime.datetime.strptime(file_name.split("_")[1][:8], '%Y%m%d')
            spec["spec"]["dataSchema"]["granularitySpec"]["intervals"] = ["{}/{}".format(
                str(from_date).split(" ")[0], str(from_date + datetime.timedelta(days=1)).split(" ")[0])]

            r = requests.post('http://127.0.0.1:8090/druid/indexer/v1/task', data=json.dumps(spec), headers=headers)
            task_id = r.json().get("task")

            polling.poll(
                lambda: requests.get('http://127.0.0.1:8090/druid/indexer/v1/task/{}/status'.format(task_id),
                                     headers=headers).json().get("status").get("status") != "RUNNING",
                step=60,
                poll_forever=True
            )

            os.remove(output_file_name)
            logging.info("{} processed with status {}".format(output_file_name, requests.
                                                              get('http://127.0.0.1:8090/druid/indexer/v1/task/{}/status'.
                                                                  format(task_id), headers=headers).json().get("status").
                                                              get("status")))
    except Exception as e:
        logging.info("{} processed with error {}".format(output_file_name, e))
        continue
